#!/bin/sh

set -e

file=testurls.txt

if [ "$1" ] ; then
    file="$1"
fi

cat $file | while read url ; do
    case "$url" in
      http*)
        # Save with URL as filename, replacing / with % and dropping trailing slash.
        filename=$(echo "$url" | sed 's%/$%%' |tr / %)
        harfile="har-data/$filename.har"
        if [ -e "$harfile" ] ; then
            echo found $harfile, skipping
            continue
        fi
        echo "testing $url"
        if phantomjs netsniff.js "$url" > "$harfile.new" && 
            [ -s "$harfile.new" ]; then
            mv "$harfile.new" "$harfile"
        else
            rm "$harfile.new"
        fi
        ;;
    esac
done
